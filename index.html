<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ec407a">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://media.giphy.com">
  <title>Will You Be My Valentine?</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&family=Quicksand:wght@400;600&display=swap');

    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 30%, #f48fb1 60%, #ec407a 100%);
      font-family: 'Quicksand', sans-serif;
      overflow: hidden;
      position: relative;
    }

    /* Floating hearts background */
    .hearts-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .floating-heart {
      position: absolute;
      bottom: -40px;
      color: rgba(255, 255, 255, 0.25);
      animation: floatUp linear infinite;
      font-size: 24px;
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0) rotate(0deg) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-110vh) rotate(360deg) scale(0.5);
        opacity: 0;
      }
    }

    /* Main card */
    .card {
      position: relative;
      z-index: 1;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 48px 40px;
      text-align: center;
      box-shadow:
        0 20px 60px rgba(233, 30, 99, 0.2),
        0 0 0 1px rgba(255, 255, 255, 0.5) inset;
      max-width: 460px;
      width: 90%;
      animation: cardEntrance 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }

    @keyframes cardEntrance {
      from {
        opacity: 0;
        transform: scale(0.8) translateY(30px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .bear-gif {
      width: 160px;
      height: 160px;
      margin: 0 auto 16px;
      border-radius: 16px;
      overflow: hidden;
    }

    .bear-gif img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    h1 {
      font-family: 'Dancing Script', cursive;
      font-size: 2.4rem;
      color: #c2185b;
      margin-bottom: 8px;
      line-height: 1.2;
    }

    .subtitle {
      color: #e91e63;
      font-size: 1rem;
      margin-bottom: 32px;
      opacity: 0.8;
    }

    .buttons {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      min-height: 80px;
      position: relative;
    }

    .btn {
      border: none;
      border-radius: 50px;
      padding: 14px 36px;
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
    }

    .btn-yes {
      background: linear-gradient(135deg, #e91e63, #c2185b);
      color: white;
      box-shadow: 0 4px 20px rgba(233, 30, 99, 0.4);
    }

    .btn-yes:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 28px rgba(233, 30, 99, 0.5);
    }

    .btn-no {
      background: linear-gradient(135deg, #78909c, #546e7a);
      color: white;
      box-shadow: 0 4px 15px rgba(84, 110, 122, 0.3);
      position: relative;
      transition: left 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), top 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .btn-no.runaway {
      position: fixed;
      z-index: 100;
    }

    .shy-tooltip {
      position: fixed;
      z-index: 101;
      background: white;
      color: #c2185b;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
      font-family: 'Quicksand', sans-serif;
    }

    .shy-tooltip.visible {
      opacity: 1;
    }

    /* Success state */
    .success-overlay {
      position: fixed;
      inset: 0;
      z-index: 200;
      background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 50%, #f48fb1 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s;
    }

    .success-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .success-content {
      text-align: center;
      animation: successBounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    }

    @keyframes successBounce {
      from {
        opacity: 0;
        transform: scale(0.5);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .success-content h1 {
      font-size: 4rem;
      color: #c2185b;
      margin-bottom: 12px;
    }

    .success-emoji {
      font-size: 3rem;
      margin-bottom: 20px;
      animation: emojiPulse 1.5s ease-in-out infinite;
    }

    @keyframes emojiPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .success-gif {
      width: 240px;
      height: 240px;
      border-radius: 20px;
      overflow: hidden;
      margin: 20px auto;
      box-shadow: 0 10px 40px rgba(233, 30, 99, 0.3);
    }

    .success-gif img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .success-subtext {
      font-family: 'Dancing Script', cursive;
      font-size: 1.5rem;
      color: #ad1457;
      margin-top: 16px;
    }

    /* Confetti */
    .confetti-container {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 201;
    }

    .confetti-piece {
      position: absolute;
      top: -20px;
      width: 12px;
      height: 12px;
      opacity: 0;
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(110vh) rotate(720deg);
        opacity: 0;
      }
    }

    /* Snake game overlay */
    .game-overlay {
      position: fixed;
      inset: 0;
      z-index: 300;
      background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 50%, #f48fb1 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.6s;
    }

    .game-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .game-title {
      font-family: 'Dancing Script', cursive;
      font-size: 1.6rem;
      color: #c2185b;
      margin-bottom: 8px;
    }

    .game-score {
      font-family: 'Quicksand', sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      color: #ad1457;
      margin-bottom: 12px;
    }

    .game-canvas-wrap {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(233, 30, 99, 0.25);
      line-height: 0;
      touch-action: none;
    }

    #snakeCanvas {
      display: block;
      background: #fff5f8;
    }

    .game-hint {
      font-family: 'Quicksand', sans-serif;
      font-size: 0.85rem;
      color: #e91e63;
      margin-top: 10px;
      opacity: 0.8;
    }

    .game-over-panel {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(6px);
      border-radius: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .game-over-panel.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .game-over-panel h2 {
      font-family: 'Dancing Script', cursive;
      font-size: 2rem;
      color: #c2185b;
      margin-bottom: 8px;
    }

    .game-over-panel p {
      font-family: 'Quicksand', sans-serif;
      color: #ad1457;
      font-size: 1rem;
      margin-bottom: 16px;
    }

    .btn-play-again {
      border: none;
      border-radius: 50px;
      padding: 12px 32px;
      font-family: 'Quicksand', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #e91e63, #c2185b);
      color: white;
      box-shadow: 0 4px 20px rgba(233, 30, 99, 0.4);
      transition: transform 0.2s, box-shadow 0.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .btn-play-again:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 28px rgba(233, 30, 99, 0.5);
    }

    .btn-play-again:focus-visible {
      outline: 3px solid #ad1457;
      outline-offset: 3px;
    }

    /* Focus states */
    .btn:focus-visible {
      outline: 3px solid #ad1457;
      outline-offset: 3px;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .floating-heart,
      .success-emoji,
      .confetti-piece {
        animation: none;
      }

      .card {
        animation: none;
      }

      .success-content {
        animation: none;
      }

      .btn,
      .btn-no,
      .shy-tooltip,
      .success-overlay {
        transition: none;
      }
    }

    /* Responsive */
    @media (max-width: 480px) {
      .card {
        padding: 32px 24px;
      }

      h1 {
        font-size: 1.9rem;
      }

      .bear-gif {
        width: 120px;
        height: 120px;
      }

      .btn {
        padding: 12px 28px;
        font-size: 1rem;
      }

      .success-content h1 {
        font-size: 3rem;
      }

      .success-gif {
        width: 180px;
        height: 180px;
      }
    }
  </style>
</head>
<body>

  <div class="hearts-bg" id="heartsBg" aria-hidden="true"></div>

  <main class="card" id="mainCard">
    <div class="bear-gif">
      <img
        src="https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3dWI3N3ZweW0wYzJ6eGV0cGxrMWg4aW9ibG1lNGluZzRjamc4MXU5ciZlcD12MV9naWZzX3NlYXJjaCZjdD1n/XBHZ6DR6JRbCV68tC4/giphy.gif"
        alt="Chii happy"
        width="160"
        height="160"
        loading="eager"
      >
    </div>
    <h1>Will You Be My Valentine?</h1>
    <p class="subtitle" aria-live="polite" id="subtitle">Please say yes...</p>
    <div class="buttons" id="buttonsContainer">
      <button class="btn btn-yes" id="btnYes" type="button">Yes</button>
      <button class="btn btn-no" id="btnNo" type="button">No</button>
    </div>
  </main>

  <div class="shy-tooltip" id="shyTooltip" aria-hidden="true"></div>

  <div class="success-overlay" id="successOverlay" role="dialog" aria-label="Success celebration">
    <div class="success-content">
      <div class="success-emoji">&#x1F970;&#x1F496;&#x1F389;</div>
      <h1>Yay!</h1>
      <div class="success-gif">
        <img
          src="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExeTdjenhrbGduaHg4eHVxczBodWo4NDRrem5zNXhlcTNmMTVkYzF2aCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/TCRZOhtnTJ1Ao6bjbk/giphy.gif"
          alt="Happy celebration with hearts"
          width="240"
          height="240"
          loading="lazy"
        >
      </div>
      <p class="success-subtext">I knew you'd say yes! &#x2764;&#xFE0F;</p>
    </div>
    <div class="confetti-container" id="confettiContainer" aria-hidden="true"></div>
  </div>

  <div class="game-overlay" id="gameOverlay" role="region" aria-label="Snake game">
    <p class="game-title">Collect 5 Yes hearts to win!</p>
    <p class="game-score">Score: <span id="gameScore">0</span> / 5</p>
    <div class="game-canvas-wrap" style="position: relative;">
      <canvas id="snakeCanvas" width="400" height="400"></canvas>
      <div class="game-over-panel" id="gameOverPanel">
        <h2>Game Over!</h2>
        <p>Your score: <span id="finalScore">0</span></p>
        <button class="btn-play-again" id="btnPlayAgain" type="button">Play Again</button>
      </div>
    </div>
    <p class="game-hint" id="gameHint"></p>
  </div>

  <script>
    (function () {
      'use strict';

      const btnYes = document.getElementById('btnYes');
      const btnNo = document.getElementById('btnNo');
      const subtitle = document.getElementById('subtitle');
      const shyTooltip = document.getElementById('shyTooltip');
      const successOverlay = document.getElementById('successOverlay');
      const confettiContainer = document.getElementById('confettiContainer');
      const heartsBg = document.getElementById('heartsBg');

      const isMobile = /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(
        navigator.userAgent
      ) || (window.matchMedia && window.matchMedia('(pointer: coarse)').matches);

      let noClickCount = 0;
      let yesScale = 1;
      let noIsRunaway = false;

      const shyMessages = [
        "I'm too shy! >.<",
        "You can't catch me!",
        "Nope, not here~",
        "Try the other button!",
        "Hehe, missed me!",
        "I keep running away~",
        "Just say yes already!",
        "Stop chasing me!",
        "The YES button is right there!",
        "I'll never let you click me!",
      ];

      const subtitleMessages = [
        "Please say yes...",
        "Are you sure? Think again!",
        "Pretty please?",
        "Come on, say yes!",
        "You're breaking my heart!",
        "I won't give up!",
        "The right answer is YES!",
        "You know you want to...",
        "Last chance... just kidding!",
        "YES is the only option!",
      ];

      // --- Floating hearts background ---
      function createFloatingHearts() {
        const hearts = ['\u2764\uFE0F', '\u{1F493}', '\u{1F495}', '\u{1F496}', '\u{1F497}', '\u{1F49E}'];
        for (let i = 0; i < 20; i++) {
          const span = document.createElement('span');
          span.className = 'floating-heart';
          span.textContent = hearts[i % hearts.length];
          span.style.left = Math.random() * 100 + '%';
          span.style.fontSize = (14 + Math.random() * 20) + 'px';
          span.style.animationDuration = (6 + Math.random() * 8) + 's';
          span.style.animationDelay = (Math.random() * 10) + 's';
          heartsBg.appendChild(span);
        }
      }
      createFloatingHearts();

      // --- Move No button to random spot near the card ---
      function moveNoButton() {
        const btnRect = btnNo.getBoundingClientRect();
        if (!noIsRunaway) {
          noIsRunaway = true;
          btnNo.classList.add('runaway');
        }
        const cardRect = document.getElementById('mainCard').getBoundingClientRect();
        const pad = 80;
        const minX = Math.max(10, cardRect.left - pad);
        const maxX = Math.min(window.innerWidth - btnRect.width - 10, cardRect.right + pad - btnRect.width);
        const minY = Math.max(10, cardRect.top - pad);
        const maxY = Math.min(window.innerHeight - btnRect.height - 10, cardRect.bottom + pad);
        const x = minX + Math.random() * (maxX - minX);
        const y = minY + Math.random() * (maxY - minY);
        btnNo.style.left = x + 'px';
        btnNo.style.top = y + 'px';
      }

      // --- Grow Yes button ---
      function growYesButton() {
        yesScale += 0.15;
        btnYes.style.transform = 'scale(' + yesScale + ')';
      }

      // --- Update subtitle ---
      function updateSubtitle() {
        const idx = Math.min(noClickCount, subtitleMessages.length - 1);
        subtitle.textContent = subtitleMessages[idx];
      }

      // --- Show shy tooltip (desktop) ---
      function showShyTooltip(x, y) {
        const msg = shyMessages[noClickCount % shyMessages.length];
        shyTooltip.textContent = msg;
        shyTooltip.style.left = x + 'px';
        shyTooltip.style.top = (y - 40) + 'px';
        shyTooltip.classList.add('visible');
        clearTimeout(shyTooltip._timer);
        shyTooltip._timer = setTimeout(function () {
          shyTooltip.classList.remove('visible');
        }, 1200);
      }

      // --- Mobile: click handler on No ---
      if (isMobile) {
        btnNo.addEventListener('click', function (e) {
          e.preventDefault();
          noClickCount++;
          moveNoButton();
          growYesButton();
          updateSubtitle();
        });
      } else {
        // --- Desktop: mousemove proximity detection ---
        let runawayThreshold = 120;

        document.addEventListener('mousemove', function (e) {
          const rect = btnNo.getBoundingClientRect();
          const btnCenterX = rect.left + rect.width / 2;
          const btnCenterY = rect.top + rect.height / 2;
          const dx = e.clientX - btnCenterX;
          const dy = e.clientY - btnCenterY;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < runawayThreshold) {
            noClickCount++;
            moveNoButton();
            updateSubtitle();
            showShyTooltip(
              rect.left + rect.width / 2,
              rect.top
            );
          }
        });

        // Fallback: if somehow clicked on desktop
        btnNo.addEventListener('click', function (e) {
          e.preventDefault();
          noClickCount++;
          moveNoButton();
          updateSubtitle();
        });
      }

      // --- Yes button click ---
      btnYes.addEventListener('click', function () {
        startSnakeGame();
      });

      // --- Confetti ---
      function launchConfetti() {
        var colors = ['#e91e63', '#f44336', '#ff5722', '#ff9800', '#ffeb3b', '#4caf50', '#2196f3', '#9c27b0'];
        var shapes = ['\u2764', '\u2B50', '\u25CF'];
        for (var i = 0; i < 80; i++) {
          var piece = document.createElement('span');
          piece.className = 'confetti-piece';
          piece.textContent = shapes[i % shapes.length];
          piece.style.left = Math.random() * 100 + '%';
          piece.style.color = colors[i % colors.length];
          piece.style.fontSize = (10 + Math.random() * 16) + 'px';
          piece.style.animation = 'confettiFall ' + (2 + Math.random() * 3) + 's linear ' + (Math.random() * 1.5) + 's forwards';
          confettiContainer.appendChild(piece);
        }
      }

      // ========================================
      // SNAKE GAME
      // ========================================
      var gameOverlay = document.getElementById('gameOverlay');
      var canvas = document.getElementById('snakeCanvas');
      var ctx = canvas.getContext('2d');
      var scoreEl = document.getElementById('gameScore');
      var finalScoreEl = document.getElementById('finalScore');
      var gameOverPanel = document.getElementById('gameOverPanel');
      var btnPlayAgain = document.getElementById('btnPlayAgain');
      var gameHint = document.getElementById('gameHint');

      // Preload PNG assets
      var imgSnake = new Image();
      var imgYes = new Image();
      var imgNo = new Image();
      imgSnake.src = 'assets/001.png';
      imgYes.src = 'assets/040.png';
      imgNo.src = 'assets/038.png';

      var GRID = 12;
      var WIN_SCORE = 5;
      var cellSize;
      var snake, direction, nextDirection, apple, poisons, score, gameRunning, animFrameId, lastTick;
      var TICK_MS = 150;

      function sizeCanvas() {
        var maxDim = Math.min(window.innerWidth - 40, window.innerHeight - 180, 500);
        maxDim = Math.floor(maxDim / GRID) * GRID;
        canvas.width = maxDim;
        canvas.height = maxDim;
        cellSize = maxDim / GRID;
      }

      function randomCell(excludeList) {
        var attempts = 0;
        while (attempts < 200) {
          var x = Math.floor(Math.random() * GRID);
          var y = Math.floor(Math.random() * GRID);
          var collision = false;
          for (var i = 0; i < excludeList.length; i++) {
            if (excludeList[i].x === x && excludeList[i].y === y) {
              collision = true;
              break;
            }
          }
          if (!collision) return { x: x, y: y };
          attempts++;
        }
        return { x: 0, y: 0 };
      }

      function spawnPoisons(count) {
        var occupied = snake.concat([apple]);
        poisons = [];
        for (var i = 0; i < count; i++) {
          var p = randomCell(occupied.concat(poisons));
          poisons.push(p);
        }
      }

      function initGame() {
        sizeCanvas();
        var cx = Math.floor(GRID / 2);
        var cy = Math.floor(GRID / 2);
        snake = [
          { x: cx, y: cy },
          { x: cx - 1, y: cy },
          { x: cx - 2, y: cy }
        ];
        direction = { x: 1, y: 0 };
        nextDirection = { x: 1, y: 0 };
        score = 0;
        scoreEl.textContent = '0';
        apple = randomCell(snake);
        spawnPoisons(3);
        gameOverPanel.classList.remove('visible');
        gameRunning = true;
        lastTick = 0;
      }

      function drawImg(img, x, y, scale) {
        var s = scale || 1;
        var size = cellSize * s;
        var offset = (cellSize - size) / 2;
        ctx.drawImage(img, x * cellSize + offset, y * cellSize + offset, size, size);
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw grid background
        for (var gx = 0; gx < GRID; gx++) {
          for (var gy = 0; gy < GRID; gy++) {
            ctx.fillStyle = (gx + gy) % 2 === 0 ? '#fff5f8' : '#fce4ec';
            ctx.fillRect(gx * cellSize, gy * cellSize, cellSize, cellSize);
          }
        }

        // Draw poisons (038.png)
        for (var i = 0; i < poisons.length; i++) {
          drawImg(imgNo, poisons[i].x, poisons[i].y, 1.1);
        }

        // Draw apple / yes (040.png)
        drawImg(imgYes, apple.x, apple.y, 1.2);

        // Draw snake body (pink rounded segments)
        for (var j = snake.length - 1; j >= 1; j--) {
          var px = snake[j].x * cellSize;
          var py = snake[j].y * cellSize;
          ctx.fillStyle = '#f8bbd0';
          ctx.beginPath();
          ctx.roundRect(px + 2, py + 2, cellSize - 4, cellSize - 4, cellSize * 0.3);
          ctx.fill();
          // Cheek blush on body segments
          ctx.fillStyle = 'rgba(233, 30, 99, 0.15)';
          ctx.beginPath();
          ctx.arc(px + cellSize / 2, py + cellSize / 2, cellSize * 0.2, 0, Math.PI * 2);
          ctx.fill();
        }

        // Draw snake head (001.png)
        drawImg(imgSnake, snake[0].x, snake[0].y, 1.3);
      }

      function tick() {
        direction = nextDirection;
        var head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

        // Wall collision
        if (head.x < 0 || head.x >= GRID || head.y < 0 || head.y >= GRID) {
          return gameOver();
        }

        // Self collision
        for (var i = 0; i < snake.length; i++) {
          if (snake[i].x === head.x && snake[i].y === head.y) {
            return gameOver();
          }
        }

        // Poison collision
        for (var p = 0; p < poisons.length; p++) {
          if (poisons[p].x === head.x && poisons[p].y === head.y) {
            return gameOver();
          }
        }

        snake.unshift(head);

        // Apple collision
        if (head.x === apple.x && head.y === apple.y) {
          score++;
          scoreEl.textContent = score;

          // WIN CONDITION
          if (score >= WIN_SCORE) {
            gameRunning = false;
            // Transition to Yay celebration
            setTimeout(function () {
              gameOverlay.classList.remove('active');
              successOverlay.classList.add('active');
              launchConfetti();
            }, 400);
            return;
          }

          apple = randomCell(snake.concat(poisons));
          spawnPoisons(Math.min(3 + Math.floor(score / 2), 6));
        } else {
          snake.pop();
        }
      }

      function gameOver() {
        gameRunning = false;
        finalScoreEl.textContent = score;
        gameOverPanel.classList.add('visible');
      }

      function gameLoop(timestamp) {
        if (!gameRunning) {
          draw();
          return;
        }
        animFrameId = requestAnimationFrame(gameLoop);
        if (timestamp - lastTick >= TICK_MS) {
          lastTick = timestamp;
          tick();
        }
        draw();
      }

      function startSnakeGame() {
        gameOverlay.classList.add('active');
        gameHint.textContent = isMobile ? 'Swipe to change direction' : 'Use arrow keys to move';
        initGame();
        animFrameId = requestAnimationFrame(gameLoop);
      }

      btnPlayAgain.addEventListener('click', function () {
        initGame();
        animFrameId = requestAnimationFrame(gameLoop);
      });

      // --- Desktop: Arrow key controls ---
      document.addEventListener('keydown', function (e) {
        if (!gameRunning) return;
        var key = e.key;
        if (key === 'ArrowUp' && direction.y !== 1) {
          nextDirection = { x: 0, y: -1 };
          e.preventDefault();
        } else if (key === 'ArrowDown' && direction.y !== -1) {
          nextDirection = { x: 0, y: 1 };
          e.preventDefault();
        } else if (key === 'ArrowLeft' && direction.x !== 1) {
          nextDirection = { x: -1, y: 0 };
          e.preventDefault();
        } else if (key === 'ArrowRight' && direction.x !== -1) {
          nextDirection = { x: 1, y: 0 };
          e.preventDefault();
        }
      });

      // --- Mobile: Swipe controls ---
      var touchStartX = 0;
      var touchStartY = 0;

      gameOverlay.addEventListener('touchstart', function (e) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }, { passive: true });

      gameOverlay.addEventListener('touchend', function (e) {
        if (!gameRunning) return;
        var dx = e.changedTouches[0].clientX - touchStartX;
        var dy = e.changedTouches[0].clientY - touchStartY;
        var absDx = Math.abs(dx);
        var absDy = Math.abs(dy);

        // Minimum swipe distance
        if (Math.max(absDx, absDy) < 20) return;

        if (absDx > absDy) {
          if (dx > 0 && direction.x !== -1) {
            nextDirection = { x: 1, y: 0 };
          } else if (dx < 0 && direction.x !== 1) {
            nextDirection = { x: -1, y: 0 };
          }
        } else {
          if (dy > 0 && direction.y !== -1) {
            nextDirection = { x: 0, y: 1 };
          } else if (dy < 0 && direction.y !== 1) {
            nextDirection = { x: 0, y: -1 };
          }
        }
      }, { passive: true });

      // Handle resize
      window.addEventListener('resize', function () {
        if (gameOverlay.classList.contains('active')) {
          sizeCanvas();
        }
      });

    })();
  </script>
</body>
</html>
